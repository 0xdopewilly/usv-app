ğŸ—ï¸ Folder Structure in Your Replit:
text
/
â”œâ”€â”€ src/                    (your existing app)
â”œâ”€â”€ backend/               (NEW - QR system)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ QRCode.js
â”‚   â”‚   â””â”€â”€ ClaimValidator.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ qr-routes.js
â”‚   â””â”€â”€ server.js
â”œâ”€â”€ package.json          (update this)
â””â”€â”€ .env                  (update this)
ğŸ“¦ 1. Install Required Packages:
Add these to your package.json:

json
{
  "dependencies": {
    "qrcode": "^1.5.3",
    "crypto": "^1.0.1",
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "mongodb": "^5.8.1"
  }
}
Run: npm install

ğŸ”§ 2. QR Code Model (backend/models/QRCode.js):
javascript
const { MongoClient, ObjectId } = require('mongodb');
const QRCode = require('qrcode');
const crypto = require('crypto');

class QRGenerator {
  constructor() {
    this.client = new MongoClient(process.env.MONGODB_URI);
    this.db = null;
    this.collection = null;
    this.init();
  }

  async init() {
    await this.client.connect();
    this.db = this.client.db('usv_qr_system');
    this.collection = this.db.collection('qr_codes');
  }

  generateUniqueCode(prefix = "USV") {
    const random = crypto.randomBytes(8).toString('hex').toUpperCase();
    return `${prefix}-${random.substring(0,4)}-${random.substring(4,8)}-${random.substring(8,12)}`;
  }

  async generateQRImage(code, productName) {
    const claimUrl = `${process.env.APP_URL}/claim?code=${code}`;
    return await QRCode.toDataURL(claimUrl);
  }

  async generateBatch(productId, quantity = 100, tokens = 1000) {
    const batch = [];
    
    for (let i = 0; i < quantity; i++) {
      const code = this.generateUniqueCode();
      const qrImage = await this.generateQRImage(code, productId);
      
      batch.push({
        code,
        product_id: productId,
        tokens: tokens,
        qr_image: qrImage,
        created_at: new Date(),
        claimed: false,
        claimed_by: null,
        claimed_at: null,
        tx_hash: null
      });
    }
    
    // Insert into database
    await this.collection.insertMany(batch);
    
    return batch.map(item => ({
      code: item.code,
      qr_image: item.qr_image,
      product: item.product_id,
      tokens: item.tokens
    }));
  }

  async validateClaim(code, userWallet) {
    // Find unclaimed code
    const qrCode = await this.collection.findOne({ 
      code: code, 
      claimed: false 
    });
    
    if (!qrCode) {
      throw new Error("Invalid or already claimed QR code");
    }

    // Check if user already claimed this product
    const existingClaim = await this.collection.findOne({
      product_id: qrCode.product_id,
      claimed_by: userWallet,
      claimed: true
    });
    
    if (existingClaim) {
      throw new Error("You already claimed tokens for this product type");
    }

    return qrCode;
  }

  async markAsClaimed(code, userWallet, txHash) {
    await this.collection.updateOne(
      { code: code },
      { 
        $set: { 
          claimed: true,
          claimed_by: userWallet,
          claimed_at: new Date(),
          tx_hash: txHash
        }
      }
    );
  }

  async getClaimStats() {
    const total = await this.collection.countDocuments();
    const claimed = await this.collection.countDocuments({ claimed: true });
    const unclaimed = await this.collection.countDocuments({ claimed: false });
    
    return { total, claimed, unclaimed };
  }
}

module.exports = QRGenerator;
ğŸ”§ 3. Claim Validator (backend/models/ClaimValidator.js):
javascript
const { Connection, PublicKey, Transaction } = require("@solana/web3.js");
const { getAssociatedTokenAddress, createTransferInstruction } = require("@solana/spl-token");

class ClaimValidator {
  constructor() {
    this.connection = new Connection(process.env.SOLANA_RPC_URL);
    this.tokenMint = new PublicKey(process.env.TOKEN_MINT);
    this.companyWallet = null; // You'll set this
  }

  async createTransferTransaction(userWallet, amount) {
    const fromTokenAccount = await getAssociatedTokenAddress(
      this.tokenMint,
      this.companyWallet.publicKey
    );
    
    const toTokenAccount = await getAssociatedTokenAddress(
      this.tokenMint,
      new PublicKey(userWallet)
    );

    const transaction = new Transaction().add(
      createTransferInstruction(
        fromTokenAccount,
        toTokenAccount,
        this.companyWallet.publicKey,
        amount * Math.pow(10, 6) // Adjust for decimals
      )
    );

    return transaction;
  }

  async processClaim(qrCode, userWallet) {
    // In production, you'd actually send the transaction
    // For now, we'll simulate success
    const mockTxHash = crypto.randomBytes(32).toString('hex');
    
    return {
      success: true,
      tokens: qrCode.tokens,
      transaction: mockTxHash,
      message: "Tokens transferred successfully"
    };
  }
}

module.exports = ClaimValidator;
ğŸ”§ 4. QR Routes (backend/routes/qr-routes.js):
javascript
const express = require('express');
const router = express.Router();
const QRGenerator = require('../models/QRCode');
const ClaimValidator = require('../models/ClaimValidator');

const qrGenerator = new QRGenerator();
const claimValidator = new ClaimValidator();

// Generate QR Codes (Admin)
router.post('/generate', async (req, res) => {
  try {
    const { product_id, quantity, tokens = 1000, admin_key } = req.body;
    
    // Simple admin validation
    if (admin_key !== process.env.ADMIN_API_KEY) {
      return res.status(401).json({ error: "Unauthorized" });
    }
    
    const codes = await qrGenerator.generateBatch(product_id, quantity, tokens);
    
    res.json({
      success: true,
      message: `Generated ${quantity} QR codes`,
      codes: codes
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Claim Tokens (Users)
router.post('/claim', async (req, res) => {
  try {
    const { qr_code, wallet_address } = req.body;
    
    if (!qr_code || !wallet_address) {
      return res.status(400).json({ error: "QR code and wallet address required" });
    }
    
    // Validate QR code
    const validCode = await qrGenerator.validateClaim(qr_code, wallet_address);
    
    // Process token transfer
    const result = await claimValidator.processClaim(validCode, wallet_address);
    
    // Mark as claimed
    await qrGenerator.markAsClaimed(qr_code, wallet_address, result.transaction);
    
    res.json({
      success: true,
      tokens: validCode.tokens,
      transaction: result.transaction,
      message: "Tokens claimed successfully!"
    });
    
  } catch (error) {
    res.status(400).json({ 
      success: false, 
      error: error.message 
    });
  }
});

// Get Stats (Admin)
router.get('/stats', async (req, res) => {
  try {
    const stats = await qrGenerator.getClaimStats();
    res.json({ success: true, stats });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Get All Codes (Admin)
router.get('/codes', async (req, res) => {
  try {
    const codes = await qrGenerator.collection.find({}).toArray();
    res.json({ success: true, codes });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

module.exports = router;
ğŸ”§ 5. Backend Server (backend/server.js):
javascript
const express = require('express');
const cors = require('cors');
const QRroutes = require('./routes/qr-routes');

const app = express();
const PORT = process.env.QR_PORT || 3001;

app.use(cors());
app.use(express.json());

// QR Code APIs
app.use('/api/qr', QRroutes);

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'QR Backend Running', timestamp: new Date() });
});

app.listen(PORT, () => {
  console.log(`ğŸš€ QR Backend running on port ${PORT}`);
  console.log(`ğŸ“‹ Endpoints:`);
  console.log(`   POST /api/qr/generate - Generate QR codes`);
  console.log(`   POST /api/qr/claim - Claim tokens`);
  console.log(`   GET /api/qr/stats - Get statistics`);
  console.log(`   GET /api/qr/codes - Get all codes`);
});
ğŸ”§ 6. Update Your Environment (.env):
env
# Add these to your existing .env
QR_PORT=3001
MONGODB_URI=mongodb://localhost:27017
ADMIN_API_KEY=usv_admin_2024_secret
APP_URL=https://yourapp.com
TOKEN_MINT=A9Vnuav6Wd4azfrzKwpK1Z62frmJb7G3Ydr3FkvGKH8W
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
ğŸ”§ 7. Update Your Mobile App:
Add this to your existing app:

javascript
// Add this function to your app
const claimTokensFromQR = async (qrCodeData) => {
  try {
    const userWallet = await getWalletAddress(); // Your existing function
    
    const response = await fetch('http://localhost:3001/api/qr/claim', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        qr_code: qrCodeData,
        wallet_address: userWallet
      })
    });
    
    const result = await response.json();
    return result;
    
  } catch (error) {
    console.error('Claim error:', error);
    return { success: false, error: 'Network error' };
  }
};

// Update your QR scanner
const handleQRScanned = async (e) => {
  const qrData = e.data;
  
  // Show loading
  setLoading(true);
  
  const result = await claimTokensFromQR(qrData);
  
  setLoading(false);
  
  if (result.success) {
    alert(`ğŸ‰ Success! You received ${result.tokens} USV tokens!`);
    // Refresh wallet balance
    await refreshWalletBalance();
  } else {
    alert(`âŒ Claim failed: ${result.error}`);
  }
};
ğŸš€ 8. Start the Backend:
Add this script to your package.json:

json
{
  "scripts": {
    "dev": "node src/app.js",
    "qr-backend": "node backend/server.js",
    "dev:all": "concurrently \"npm run dev\" \"npm run qr-backend\""
  }
}
Run: npm run qr-backend

ğŸ“‹ 9. Generate Your First QR Codes:
bash
curl -X POST http://localhost:3001/api/qr/generate \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": "ultra_smooth_blue",
    "quantity": 10,
    "tokens": 1000,
    "admin_key": "usv_admin_2024_secret"
  }'